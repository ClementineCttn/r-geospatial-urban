---
title: 'Raster Calculations'
teaching: 25
exercises: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(terra)

DSM_TUD <- rast("data/tud-dsm-5m.tif")
DSM_TUD_df <- as.data.frame(DSM_TUD, xy = TRUE)

DTM_TUD <- rast("data/tud-dtm-5m.tif")
DTM_TUD_df <- as.data.frame(DTM_TUD, xy = TRUE)
```

:::::::::::::::::::::::::::::::::::::: questions 

- How do I subtract one raster from another and extract pixel values for defined locations?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Perform a subtraction between two rasters using raster math.
- Export raster data as a GeoTIFF file.

::::::::::::::::::::::::::::::::::::::::::::::::

::: prereq

# Things you'll need to complete this episode

See the [lesson homepage]() for detailed information about the software, data, and other prerequisites you will need to work through the examples in this episode.

<!-- This lesson uses the `terra` package in particular. If you have not installed it yet, do so by running `install.packages("terra")` before loading it with `library(terra)`. -->

:::

We often want to combine values of and perform calculations on rasters to create a new output raster. This episode covers how to subtract one raster from another using basic raster math and the `lapp()` function. It also covers how to extract pixel values from a set of locations - for example a buffer region around plot locations at a field site.


## Raster calculations in R

We often want to perform calculations on two or more rasters to create a new output raster. For example, if we are interested in mapping the heights of trees and buildings across an entire field site, we might want to calculate the difference between the Digital Surface Model (DSM, tops of trees and buildings) and the Digital Terrain Model (DTM, ground level). The resulting dataset is referred to as a Canopy Height Model (CHM) and represents the actual height of trees, buildings, etc. with the influence of ground elevation removed.

![Source: National Ecological Observatory Network (NEON).](https://datacarpentry.org/r-raster-vector-geospatial/fig/dc-spatial-raster/lidarTree-height.png)

## Load the Data

For this episode, we will use the DTM and DSM data which we already have loaded from previous episodes.

We use the `describe()` function to view information about the DTM and DSM data files. 
```{r}
describe("data/tud-dtm-5m.tif")
describe("data/tud-dsm-5m.tif")
```

We’ve already loaded and worked with these two data files in earlier episodes. Let’s plot them each once more to remind ourselves what this data looks like. First we’ll plot the DTM elevation data:
```{r}
 ggplot() +
      geom_raster(data = DTM_TUD_df , 
              aes(x = x, y = y, fill = `tud-dtm-5m`)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

And then the DSM elevation data:
```{r}
 ggplot() +
      geom_raster(data = DSM_TUD_df , 
              aes(x = x, y = y, fill = `tud-dsm-5m`)) +
     scale_fill_gradientn(name = "Elevation", colors = terrain.colors(10)) + 
     coord_quickmap()
```

## Raster math and Canopy Height Models

We can perform raster calculations by subtracting (or adding, multiplying, etc) two rasters. In the geospatial world, we call this “raster math”.

Let’s subtract the DTM from the DSM to create a Canopy Height Model. After subtracting, let’s create a data frame so we can plot with `ggplot`.


```{r}
CHM_TUD <- DSM_TUD - DTM_TUD
CHM_TUD_df <- as.data.frame(CHM_TUD, xy = TRUE)
```

We can now plot the output CHM.
```{r}
 ggplot() +
   geom_raster(data = CHM_TUD_df , 
               aes(x = x, y = y, fill = `tud-dsm-5m`)) + 
   scale_fill_gradientn(name = "Canopy Height", colors = terrain.colors(10)) + 
   coord_quickmap()
```

Let’s have a look at the distribution of values in our newly created Canopy Height Model (CHM).
```{r}
ggplot(CHM_TUD_df) +
    geom_histogram(aes(`tud-dsm-5m`))
```
Notice that the range of values for the output CHM is between 0 and 100 meters. Does this make sense for buildings and trees in Delft?

::: challenge

### Challenge: Explore CHM Raster Values

It’s often a good idea to explore the range of values in a raster dataset just like we might explore a dataset that we collected in the field.

1. What is the minimum and maximum value for the Canopy Height Model `CHM_TUD` that we just created?
2. What are two ways you can check this range of data for `CHM_TUD`?
3. What is the distribution of all the pixel values in the CHM?
4. Plot a histogram with 6 bins instead of the default and change the colour of the histogram.
5. Plot the `CHM_TUD` raster using breaks that make sense for the data. Include an appropriate colour palette for the data, plot title and no axes ticks / labels.

::: solution

```{r}
min(CHM_TUD_df$`tud-dsm-5m`, na.rm = TRUE)
max(CHM_TUD_df$`tud-dsm-5m`, na.rm = TRUE)

ggplot(CHM_TUD_df) +
    geom_histogram(aes(`tud-dsm-5m`))

ggplot(CHM_TUD_df) +
    geom_histogram(aes(`tud-dsm-5m`), colour="black", 
                   fill="darkgreen", bins = 6)

custom_bins <- c(0, 10, 20, 30, 100)
CHM_TUD_df <- CHM_TUD_df %>%
                  mutate(canopy_discrete = cut(`tud-dsm-5m`, breaks = custom_bins))

ggplot() +
  geom_raster(data = CHM_TUD_df , aes(x = x, y = y,
                                       fill = canopy_discrete)) + 
     scale_fill_manual(values = terrain.colors(4)) + 
     coord_quickmap()
```

:::

:::

::: callout

### Two Ways to Perform Raster Calculations

We can calculate the difference between two rasters in two different ways:

- by directly subtracting the two rasters in R using raster math,

or for more efficient processing, particularly if our rasters are large and/or the calculations we are performing are complex:

- using the `lapp()` function.

See how `lapp()` is used in [this lesson](https://datacarpentry.org/r-raster-vector-geospatial/instructor/04-raster-calculations-in-r.html#efficient-raster-calculations).

:::

## Export a GeoTIFF

Now that we’ve created a new raster, let’s export the data as a GeoTIFF file using the `writeRaster()` function.

When we write this raster object to a GeoTIFF file we’ll name it `CHM_TUD.tiff`. This name allows us to quickly remember both what the data contains (CHM data) and for where (TU Delft campus and surroundings). The `writeRaster()` function by default writes the output file to your working directory unless you specify a full file path.

We will specify the output format (“GTiff”), the no data value `NAflag = -9999`. We will also tell R to overwrite any data that is already in a file of the same name.
```{r}
writeRaster(CHM_TUD, "fig/CHM_TUD.tiff",
            filetype="GTiff",
            overwrite=TRUE,
            NAflag=-9999)
```

::::::::::::::::::::::::::::::::::::: keypoints 

- Rasters can be computed on using mathematical functions.
- The `writeRaster()` function can be used to write raster data to a file.

::::::::::::::::::::::::::::::::::::::::::::::::

